<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Install VPN on Raspberry Pi &#8211; Chao</title>
<meta name="description" content="Nothing is really attained">
<meta name="keywords" content="raspberry pi, vpn">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="/images/raspberry-pi.jpg">

<meta name="twitter:title" content="Install VPN on Raspberry Pi">
<meta name="twitter:description" content="Nothing is really attained">
<meta name="twitter:creator" content="@ohmygoddess2">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Install VPN on Raspberry Pi">
<meta property="og:description" content="Nothing is really attained">
<meta property="og:url" content="/personal/vpn-on-raspberry-pi">
<meta property="og:site_name" content="Chao">
<meta property="og:image" content="/images/raspberry-pi.jpg">





<link rel="canonical" href="/personal/vpn-on-raspberry-pi">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Chao Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <link rel="stylesheet" type="text/css" href="/assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/style.css" />

<div class="search-wrapper">
    <div class="search-form">
        <input type="text" class="search-field" placeholder="Search...">
        <i class="icon-remove-sign"></i>
        <ul class="search-results post-list"></ul><!-- /.search-results -->
    </div><!-- /.search-form -->
</div><!-- ./search-wrapper -->


<!--Load Mathjax-->
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script>
        MathJax.Hub.Config({
            config: ["MMLorHTML.js"],
            extensions: ["tex2jax.js","TeX/AMSmath.js","TeX/AMSsymbols.js"],
            jax: ["input/TeX"],
            tex2jax: {
                inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
                processEscapes: false
            },
            TeX: {
                TagSide: "right",
                TagIndent: ".8em",
                MultLineWidth: "85%",
                equationNumbers: {
                   autoNumber: "AMS",
                },
                unicode: {
                   fonts: "STIXGeneral,'Arial Unicode MS'" 
                }
            },
            showProcessingMessages: false
        });
    </script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">

</head>
<body class="post-template" itemscope itemtype="http://schema.org/WebPage">  
<div id="fade"></div>
<a id="slide" class="animated fade"></a>
<aside id="sidebar">
    <nav id="navigation">
    <h2>MENU</h2>
    <hr>

            <li>
                    <a href="/">Home</a>
                 </li>

            <li>
                    <a href="/categories">Categories</a>
                 </li>

            <li>
                    <a href="/tags">Tags</a>
                 </li>
            
           <li><a href="/feed.xml" title="Atom/RSS feed"><i class="icon-rss"></i> Feed</a></li>
    </nav>
    
    
</aside>
<header id="masthead" class="blog-background overlay align-center align-middle animated from-bottom"  style="background-image: url(/images/raspberry-pi.jpg)" itemscope itemtype="http://schema.org/Organization">


    <button class="menu-button animated fade dosearch">
        <i class="icon-search"></i>
    </button>


    <div class="inner">
        <div class="container">
            <a class="brand" href="" role="banner" itemprop="url">

                <img itemprop="logo" src="/images/moon-logo.png" alt="Chao Logo" />

            <h1 class="blog-title light" itemprop="name">
                Chao
            </h1>
                
            </a>
        </div>
    </div>
    
    
    
    
</header>
<div id="main" class="content" role="main" itemprop="mainContentOfPage" itemscope itemtype="http://schema.org/Blog">
    <div class="container">
        <div class="row">
            <article class="post col-md-8 col-md-offset-2 hentry" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
            
            
            
                    <header class="post-header entry-header">
                    
                        
                        <h1 class="post-title text-center hyper  bordered-bottom entry-title" itemprop="headline">Install VPN on Raspberry Pi</h1>
                        
                        <div class="cursive" style="color: #000; font-style:italic;"></div>
                        <div class="post-info text-center small">
                            <span class="entry-date date published updated"><time datetime="2016-05-16T00:00:00-06:00" class="post-time" itemprop="datePublished">16 May 2016</time><span>
                            in <span class="post-tags"><a href="/categories/index.html#personal" data-toggle="tooltip" title="Other posts from the Personal category" rel="tag">Personal</a></span>
                        </div>
                    </header>
                    <div class="post-body bordered-bottom" itemprop="description">
                        
                        <p>I bought a Raspberry Pi B+ model with starter kit. It includes a case, which nicely fits the raspberry pi. It also contains a 8GB microsd card with NOOBS preinstalled. So I can skip installing NOOBS on microsd card. My purpose is to setup a vpn network at my home so that I can use it when I am outside. It is more secure than using public wifi network.</p>

<figure>
        <a href="/images/gallery1/b-plus.jpg"><img src="/images/gallery1/b-plus.jpg" /></a>
</figure>

<section id="table-of-contents" class="toc">
  <header>
    <h1>Install Guildance</h1>
  </header>
<div id="drawer">
<ul id="markdown-toc">
  <li><a href="#install-raspbian-and-related-softwares" id="markdown-toc-install-raspbian-and-related-softwares">Install Raspbian and related softwares</a></li>
  <li><a href="#network-configuration" id="markdown-toc-network-configuration">Network configuration</a></li>
  <li><a href="#configure-openvpn-server-and-client" id="markdown-toc-configure-openvpn-server-and-client">Configure OpenVPN server and client</a></li>
</ul>

  </div>
</section>
<!-- /#table-of-contents -->

<h2 id="install-raspbian-and-related-softwares">Install Raspbian and related softwares</h2>
<p>The first step is to install the operating system on raspberry pi. Plug in keyboard, mouse and microsd card, connect hdmi cable with monitor. After plug in the power, it will automatically start with several options. I choose to install the Raspbian operating system at the start up page. It will take about 20 mins to finish installing the operating system. The default login is the command line enviroment. To start the GUI, just type “startx” in the terminal.
Now we can access RPI(Raspberry Pi) remotely using ssh. In order to use remote desktop service from PC, we need to install xrdp in RPI, it will install the dependency tigervncserver as well.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">sudo apt-get install xrdp <span class="o">(</span><span class="k">for </span>remote desktop access<span class="o">)</span> 
sudo update-rc.d xrdp <span class="nb">enable</span> <span class="o">(</span><span class="nb">enable </span>it at boot<span class="o">)</span></code></pre></figure>

<p>Since most of the home network use dynamic ip, we need to update our ip with the free dns domain name we get from some online provider. I choose the noip, I download linux version noip software (for dynamic dns service), use make and sudo make install to install the software. The last software to install is the openvpn.</p>

<h2 id="network-configuration">Network configuration</h2>
<p>The ip address of RPI can be found using ifconfig command. If I am using my laptop remotely, I can use nmap to scan the available ip and find it (in my case, it is 192.168.0.8).</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">nmap -sP 192.168.0.0/24</code></pre></figure>

<p>To make this internal ip static, first step is to configure the home router to make a dhcp reservation for my RPI ip address(i.e. reserve a internal ip for RPI). Then, change the interface file located in /etc/network/interfaces. Use ifconfig(ip address, netmask, broadcast address) and netstat -nr(network,gateway) to find all the information and put it there.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
    address 192.168.0.8
    netmask 255.255.255.0
    network 192.168.0.0
    broadcast 192.168.0.255
    gateway 192.168.0.1</code></pre></figure>

<p>Now we have a fixed internal ip address to connect. However, if we want to connect to RPI outside home, we need has a static ip address. Unfortunately, my home ip is dynamic ip. After some search online, I found noip is a good choice to host the dynamic dns. It provided me a dynamic hostname. First, I registered a free dns hostname on noip website. Then I installed its linux version software Dynamic Update Client (noip2) on my RPI. With some simple configuration, it will update my dynamic ip to the dns server every 30s(you can change the value). Thus, when I ssh to my RPI remotely, I can use the registered dns hostname instead of the dynamic ip address.</p>

<p>By default, Raspbian does not forward internet traffic. To enable it:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>vi /etc/sysctl.conf
net.ipv4.ip_forward<span class="o">=</span>1 <span class="o">(</span>uncomment this line<span class="o">)</span>
<span class="gp">$ </span>sysctl -p <span class="o">(</span>configure kernel parameters at runtime, -p means reload<span class="o">)</span></code></pre></figure>

<p>RPI has a build-in firewall that will block incoming connections. We need open an hole for OpenVPN in the firewall.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>vi /etc/firewall-openvpn-rules.sh
<span class="c">#! /bin/sh</span>
iptables -t nat -A POSTROUTING -s 10.20.30.0/24 -o eth0 -j SNAT --to-source 192.168.0.8</code></pre></figure>

<p>The first ip is the start ip that I chose for VPN subnet, the second is the internal ip of RPI. Next, we put it into the interfaces setup code so it runs on boot.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>chmod 700 /etc/firewall-openvpn-rules.sh
<span class="gp">$ </span>vi /etc/network/interfaces
auto eth0
iface eth0 inet static
    pre-up /etc/firewall-openvpn-rules.sh<span class="o">(</span>add this line<span class="o">)</span></code></pre></figure>

<h2 id="configure-openvpn-server-and-client">Configure OpenVPN server and client</h2>
<p>There are two major steps. The first is to create the master certificate, server certificate, client certificate, and the private keys. Please follow the following two tutorials <a href="http://readwrite.com/2014/04/10/raspberry-pi-vpn-tutorial-server-secure-web-browsing/">rpi-vpn-tutorial</a> and <a href="https://openvpn.net/index.php/open-source/documentation/howto.html">openvpn-documentation</a>. To create diffie-hellman key with size 2048, RPI will take about 3~4 hours to find a large prime number with 2048 bits. The easier way is to find such a key on your desktop or laptop and copy it onto RPI, this approach will be much faster. The dh pem file can be created by the following command</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">openssl dhparam -out dh2048.pem 2048</code></pre></figure>

<p>Actually, even 2048 bit is not secure enough nowadays. However, I just use it for myself. The most secure method is not to leak the domain name to other people. 
The second step is to write configuraion files for server and client. The tutorials mentioned above have the template available.</p>


                        <br>
                    
                    
                    <div class="entry-tags text-center">
                    
                        <i class="icon-tags"></i>&nbsp;Tagged with <a href="/tags/index.html#raspberry pi" data-toggle="tooltip" title="Posts tagged with raspberry pi" rel="tag">raspberry pi</a>&nbsp;&bull;&nbsp;<a href="/tags/index.html#vpn" data-toggle="tooltip" title="Posts tagged with vpn" rel="tag">vpn</a>
                    
                    </div>
                    
                    </div>
        </div>
                    <footer class="post-footer entry-meta">
                        
                        <div class="post-author text-center">                       
	        <img src="/images/doraemon.gif" alt="Chao's photo" itemprop="image" class="post-avatar img-circle img-responsive"/>    
	    <h4 class="bordered-bottom vcard author" itemprop="author" itemscope itemtype="http://schema.org/Person">By <span itemprop="name" class="fn"><a href="/about" title="About Chao" itemprop="url">Chao</a></span></h4>
	    <p></p>
</div> 
                        <div id="disqus_thread"></div><!-- /#disqus_thread -->
                    </footer>
            </article>
    </div>
</div>

<footer id="footer"  class="blog-background overlay text-center align-middle animated from-top" style="background-image: url(/images/raspberry-pi.jpg)" >


    <div class="inner">
        <div class="container">

            <ul class="social-icons">
            <li>
                <a href="http://twitter.com/ohmygoddess2" data-toggle="tooltip" title="Chao on Twitter" target="_blank">
                    <i class="icon-twitter"></i>
                </a>
            </li>
            
            
            
            
            
            
            <li>
                <a href="http://github.com/chaosma" data-toggle="tooltip" title="Chao on Github" target="_blank">
                    <i class="icon-github"></i>
                </a>
            </li>
        </ul>
         <!--
            <div>
                <a href="/about/">Chao</a> &copy; 2016 &bull; All rights reserved.
            </div>
         -->
            <ul class="menu-items">
            
            <li>
                
                    <a href="/"><i class="icon-home"></i></a>&nbsp;&bull;
                 
            </li>
            
            <li>
                
                    <a href="/categories">Categories</a>&nbsp;&bull;
                 
            </li>
            
            <li>
                
                    <a href="/tags">Tags</a>&nbsp;&bull;
                 
            </li>
            
            <li><a href="/feed.xml" title="Atom/RSS feed"><i class="icon-rss"></i> Feed</a></li>
        </ul>
        </div>
    </div>
    
    
    
</footer>


    
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>
<script type="text/javascript" src="/assets/js/waypoints.min.js"></script>
<script type="text/javascript" src="/assets/js/script.js"></script>
<script type='text/javascript'>console.log("HMFaysal Omega Theme Version 2.0");</script>
<script type='text/javascript'>console.log("https://alum.mit.edu/www/hmfaysal");</script>
<script type='text/javascript'>$(document).ready(function(){$(".time").text(function(a,b){return Math.round(parseFloat(b))})});</script>

<script type="text/javascript">

/*      Slides       */

$("a#slide").click(function(){
    $("#sidebar,body,a#slide,#fade").addClass("slide")
});

$("#fade,#header,#posts-container").click(function(){
    $("#sidebar,body,a#slide,#fade").removeClass("slide")
});

$("a#click-filter").click(function(){
    $("#slide-filter").slideToggle("medium");
    $("#slide-pages").slideOut("medium");
});

$("a#click-pages").click(function(){
    $("#slide-pages").slideToggle("medium");
    $("#slide-filter").slideOut("medium");
});

/*      End-Slides      */

</script>


<!-- Jekyll Simple Search option -->
<script>
  $(document).ready(function() {
      $('.search-field').simpleJekyllSearch({
          jsonFile : '/search.json',
          searchResults : '.search-results',
          template : '<li><article><a href="{url}">{title} <span class="entry-date"><time datetime="{date}">{shortdate}</time></span></a></article></li>',
          noResults: '<p>Nothing found.</p>'
        });
  });

  (function( $, window, undefined ) {
    
     var bs = {
          close: $(".icon-remove-sign"),
          searchform: $(".search-form"),
          canvas: $("body"),
          dothis: $('.dosearch')
      };
    
    bs.dothis.on('click', function() {
      $('.search-wrapper').css({ display: "block" });
      bs.searchform.toggleClass('active');
      bs.searchform.find('input').focus();
      bs.canvas.toggleClass('search-overlay');
    });
    
      bs.close.on('click', function() {
        $('.search-wrapper').removeAttr( 'style' );
        bs.searchform.toggleClass('active');
        bs.canvas.removeClass('search-overlay');
    });
  })( jQuery, window );
</script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl = 
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-76636002-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'chaosma'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> 
</body>
</html>
